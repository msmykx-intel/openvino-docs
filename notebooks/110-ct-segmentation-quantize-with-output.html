
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Quantize a Segmentation Model and Show Live Inference &#8212; OpenVINOâ„¢  documentation</title>
    
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../_static/doxyrest-pygments.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <link href="../_static/css/media/favicon.ico" rel="shortcut icon">
    <link rel="stylesheet" href="../_static/css/openvino_sphinx_theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/button.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/input.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/textfield.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/tabs.css" type="text/css" />
    <script src="../_static/js/openvino_sphinx_theme.js"></script>
    <link rel="stylesheet" href="../_static/css/viewer.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-barchart-background@1.3.0/build/Plugin.Barchart.Background.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-deferred@1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
    <script src="../_static/js/viewer.min.js"></script>
    <script src="/assets/versions_raw.js"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/tabs.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/custom.js"></script>
    <script src="../_static/js/graphs.js"></script>
    <script src="../_static/js/graphs_ov_tf.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/target-highlight.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <link rel="canonical" href="https://docs.openvino.ai/latest/notebooks/110-ct-segmentation-quantize-with-output.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Object Detection Quantization" href="111-detection-quantization-with-output.html" />
    <link rel="prev" title="Quantize a Segmentation Model and Show Live Inference" href="110-ct-segmentation-quantize-nncf-with-output.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
      <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/logo.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../pages/get-started-guide.html">
  Get Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../pages/documentation.html">
  Documentation
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../tutorials.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/api_reference.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../model_zoo.html">
  Model Zoo
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../pages/resources.html">
  Resources
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/openvinotoolkit/openvino" rel="noopener" target="_blank" title="GitHub">
            <span><i class="sst-github"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
</ul>
      </div>
      
      <div class="navbar-end-item">
        
<div class="dropdown sst-dropdown sst-dropdown-navbar">
  <button class="btn sst-btn dropdown-toggle" type="button" id="version-selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
  <div class="dropdown-menu" aria-labelledby="version-selector">
  </div>
</div>
      </div>
      
      <div class="navbar-end-item">
        

<div class="dropdown sst-dropdown sst-dropdown-navbar">
  <button class="btn sst-btn dropdown-toggle" type="button" id="language-selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">English</button>
  <div class="dropdown-menu" aria-labelledby="language-selector">
    
      
        <a class="dropdown-item font-weight-bold" href="/openvino-docs/index.html">English</a>
      
    
      
        <a  class="dropdown-item" href="/cn/openvino-docs/index.html">Chinese</a>
      
    
  </div>
</div>

      </div>
      
    </div>
  </div>
</div>
        <div id="collapse-nav-wrapper" class="container-xl">
          <button id="collapse-nav" class="button bttn-prm button-size-m" type="button" data-toggle="collapse" data-target="#nav-tree" aria-expanded="false" aria-controls="nav-tree">
            Documentation navigation <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </nav>
      <div class="transition-banner container-fluid alert alert-info alert-dismissible fade show" role="alert">
        <p>OpenVINO 2022.1 introduces a new version of OpenVINO API (API 2.0). For more information on the changes and transition steps, see the <a href="https://docs.openvino.ai/latest/openvino_2_0_transition_guide.html">transition guide</a></p>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
    </div>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar" id="nav-tree"><form class="searchForm bd-search d-flex align-items-center" action="../search.html" method="get">
    <i class="icon fas fa-search"></i>
    <input type="search" class="form-control" name="query" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notebooks
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../notebooks-installation.html">
   Installation of OpenVINOâ„¢ Notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="001-hello-world-with-output.html">
   Hello Image Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="002-openvino-api-with-output.html">
   OpenVINOâ„¢ Runtime API Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="003-hello-segmentation-with-output.html">
   Hello Image Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="004-hello-detection-with-output.html">
   Hello Object Detection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="101-tensorflow-to-openvino-with-output.html">
   Convert a TensorFlow Model to OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="102-pytorch-onnx-to-openvino-with-output.html">
   Convert a PyTorch Model to ONNX and OpenVINOâ„¢ IR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="103-paddle-onnx-to-openvino-classification-with-output.html">
   Convert a PaddlePaddle Model to ONNX and OpenVINOâ„¢ IR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="104-model-tools-with-output.html">
   Working with Open Model Zoo Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="105-language-quantize-bert-with-output.html">
   Quantize NLP models with Post-Training Optimization Tool â€‹in OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="106-auto-device-with-output.html">
   Automatic Device Selection with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="107-speech-recognition-quantization-with-output.html">
   Quantize Speech Recognition Models with OpenVINOâ„¢ Post-Training Optimization Tool â€‹
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="110-ct-segmentation-quantize-nncf-with-output.html">
   Quantize a Segmentation Model and Show Live Inference
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Quantize a Segmentation Model and Show Live Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="111-detection-quantization-with-output.html">
   Object Detection Quantization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="112-pytorch-post-training-quantization-nncf-with-output.html">
   Post-Training Quantization of PyTorch models with NNCF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="113-image-classification-quantization-with-output.html">
   Quantization of Image Classification Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="114-quantization-simplified-mode-with-output.html">
   INT8 Quantization with Post-training Optimization Tool (POT) in Simplified Mode tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="115-async-api-with-output.html">
   Asynchronous Inference with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="201-vision-monodepth-with-output.html">
   Monodepth Estimation with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="202-vision-superresolution-image-with-output.html">
   Single Image Super Resolution with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="202-vision-superresolution-video-with-output.html">
   Video Super Resolution with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="203-meter-reader-with-output.html">
   Industrial Meter Reader
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="204-named-entity-recognition-with-output.html">
   Document Entity Extraction with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="205-vision-background-removal-with-output.html">
   Image Background Removal with U^2-Net and OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="206-vision-paddlegan-anime-with-output.html">
   Photos to Anime with PaddleGAN and OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="207-vision-paddlegan-superresolution-with-output.html">
   Super Resolution with PaddleGAN and OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="208-optical-character-recognition-with-output.html">
   Optical Character Recognition (OCR) with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="209-handwritten-ocr-with-output.html">
   Handwritten Chinese and Japanese OCR with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="210-ct-scan-live-inference-with-output.html">
   Live Inference and Benchmark CT-scan Data with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="211-speech-to-text-with-output.html">
   Speech to Text with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="212-onnx-style-transfer-with-output.html">
   Style Transfer on ONNX Models with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="214-vision-paddle-classification-with-output.html">
   PaddlePaddle Image Classification with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="215-image-inpainting-with-output.html">
   Image In-painting with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="216-license-plate-recognition-with-output.html">
   License Plate Recognition with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="217-vision-deblur-with-output.html">
   Deblur Photos with DeblurGAN-v2 and OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="218-vehicle-detection-and-recognition-with-output.html">
   Vehicle Detection And Recognition with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="219-knowledge-graphs-conve-with-output.html">
   OpenVINO optimizations for Knowledge graphs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="220-yolov5-accuracy-check-and-quantization-with-output.html">
   Quantize the Ultralytics YOLOv5 model and check accuracy using the OpenVINO POT API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="221-machine-translation-with-output.html">
   Machine translation demo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="222-vision-image-colorization-with-output.html">
   Image Colorization with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="223-gpt2-text-prediction-with-output.html">
   GPT-2 Text Prediction with OpenVINO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="301-tensorflow-training-openvino-pot-with-output.html">
   Post-Training Quantization with TensorFlow Classification Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="301-tensorflow-training-openvino-with-output.html">
   From Training to Deployment with TensorFlow and OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="302-pytorch-quantization-aware-training-with-output.html">
   Quantization Aware Training with NNCF, using PyTorch framework
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="305-tensorflow-quantization-aware-training-with-output.html">
   Quantization Aware Training with NNCF, using TensorFlow Framework
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="401-object-detection-with-output.html">
   Live Object Detection with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="402-pose-estimation-with-output.html">
   Live Human Pose Estimation with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="403-action-recognition-webcam-with-output.html">
   Human Action Recognition with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="405-paddle-ocr-webcam-with-output.html">
   PaddleOCR with OpenVINOâ„¢
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="notebook_utils-with-output.html">
   Notebook Utils
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#kidney-segmentation-with-pytorch-lightning-and-openvino-part-3">
   Kidney Segmentation with PyTorch Lightning and OpenVINOâ„¢ - Part 3
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#instructions">
   Instructions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#settings">
   Settings
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#download-ct-scan-data">
   Download CT-scan Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-model-to-openvino-ir">
   Convert Model to OpenVINO IR
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#post-training-optimization-tool-pot-quantization">
   Post-Training Optimization Tool (POT) Quantization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configuration">
     Configuration
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#metric">
       Metric
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dataset">
       Dataset
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#quantization-config">
       Quantization Config
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-quantization-pipeline">
     Run Quantization Pipeline
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compare-metrics-of-fp16-and-int8-model">
   Compare Metrics of FP16 and INT8 Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compare-performance-of-the-original-and-quantized-models">
   Compare Performance of the Original and Quantized Models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visually-compare-inference-results">
   Visually Compare Inference Results
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#show-live-inference">
   Show Live Inference
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-model-and-list-of-image-files">
     Load Model and List of Image Files
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-inference">
     Show Inference
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                <div class="tocsection download-docs">
  <div class="dropdown sst-dropdown">
    <button class="button bttn-prm button-size-m" data-display="static" type="button" id="download-options"
      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Download Docs
    </button>
    <div class="dropdown-menu" aria-labelledby="download-options">
      <a class="dropdown-item" href="#" onclick="window.print()">.pdf</a>
      <a id="download-zip-btn" class="dropdown-item" href="#">.zip</a>
    </div>
  </div>
</div>
              </div>
              
            
          </div>
          

          
          
              
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">

<div class="tocsection editthispage">
    <a href="None">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

            
                <div>
                  
  <section id="quantize-a-segmentation-model-and-show-live-inference">
<h1>Quantize a Segmentation Model and Show Live Inference<a class="headerlink" href="#quantize-a-segmentation-model-and-show-live-inference" title="Permalink to this headline">Â¶</a></h1>
<section id="kidney-segmentation-with-pytorch-lightning-and-openvino-part-3">
<h2>Kidney Segmentation with PyTorch Lightning and OpenVINOâ„¢ - Part 3<a class="headerlink" href="#kidney-segmentation-with-pytorch-lightning-and-openvino-part-3" title="Permalink to this headline">Â¶</a></h2>
<p>This tutorial is a part of the series on how to train, optimize,
quantize and show live inference on a medical segmentation model. The
goal is to accelerate inference on a kidney segmentation model. The
<a class="reference external" href="https://arxiv.org/abs/1505.04597">UNet</a> model is trained from
scratch; the data is from
<a class="reference external" href="https://github.com/neheller/kits19">KiTS19</a>.</p>
<p>This third tutorial in the series shows how to:</p>
<ul class="simple">
<li><p>convert an ONNX model to OpenVINO IR with <a class="reference external" href="https://docs.openvino.ai/latest/openvino_docs_MO_DG_Deep_Learning_Model_Optimizer_DevGuide.html">Model
Optimizer</a>,</p></li>
<li><p>quantize a model with <a class="reference external" href="https://docs.openvino.ai/latest/pot_compression_api_README.html">Post-Training Optimization
Tool</a>
API in OpenVINO,</p></li>
<li><p>evaluate the F1 score metric of the original model and the quantized
model,</p></li>
<li><p>benchmark performance of the original model and the quantized model,</p></li>
<li><p>show live inference with async API and MULTI plugin in OpenVINO.</p></li>
</ul>
<p>All notebooks in this series:</p>
<ul class="simple">
<li><p><a class="reference external" href="data-preparation-ct-scan.ipynb">Data Preparation for 2D Segmentation of 3D Medical
Data</a></p></li>
<li><p><a class="reference external" href="pytorch-monai-training.ipynb">Train a 2D-UNet Medical Imaging Model with PyTorch
Lightning</a></p></li>
<li><p>Convert and Quantize a Segmentation Model and Show Live Inference
(this notebook)</p></li>
<li><p><a class="reference external" href="210-ct-scan-live-inference-with-output.html">Live Inference and Benchmark CT-scan
data</a></p></li>
</ul>
</section>
<section id="instructions">
<h2>Instructions<a class="headerlink" href="#instructions" title="Permalink to this headline">Â¶</a></h2>
<p>This notebook needs a trained UNet model that is converted to the
<a class="reference external" href="https://github.com/onnx/onnx">ONNX</a> format. Provide a pre-trained
model, trained for 20 epochs with the full
<a class="reference external" href="https://github.com/neheller/kits19">KiTS19</a> frames dataset, which
has an F1 score on the validation set of 0.9. The training code is
available in <a class="reference external" href="pytorch-monai-training.ipynb">this notebook</a>.</p>
<blockquote>
<div><p><strong>Note</strong>: Running this notebook with the full dataset will take a
long time. For demonstration purposes, this tutorial will download
one converted CT scan and use that scan for quantization and
inference. For production use, choose a larger dataset that will
provide more generalizable results.</p>
</div></blockquote>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">Â¶</a></h2>
<p>The Post Training Optimization API is implemented in the <code class="docutils literal notranslate"><span class="pre">compression</span></code>
library.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os
import random
import sys
import time
import warnings
import zipfile
from pathlib import Path

warnings.filterwarnings(&quot;ignore&quot;, category=UserWarning)

import cv2
import matplotlib.pyplot as plt
import numpy as np
from addict import Dict
from compression.api import DataLoader, Metric
from compression.engines.ie_engine import IEEngine
from compression.graph import load_model, save_model
from compression.graph.model_utils import compress_model_weights
from compression.pipeline.initializer import create_pipeline
from monai.transforms import LoadImage
from openvino.inference_engine import IECore
from yaspin import yaspin

sys.path.append(&quot;../utils&quot;)
from models.custom_segmentation import SegmentationModel
from notebook_utils import benchmark_model, download_file, show_live_inference
</pre></div>
</div>
</section>
<section id="settings">
<h2>Settings<a class="headerlink" href="#settings" title="Permalink to this headline">Â¶</a></h2>
<p>To use the pre-trained models, set <code class="docutils literal notranslate"><span class="pre">ONNX_PATH</span></code> to
<code class="docutils literal notranslate"><span class="pre">&quot;pretrained_model/unet_kits19.onnx&quot;</span></code>. To use a model that you trained
or optimized yourself, adjust <code class="docutils literal notranslate"><span class="pre">ONNX_PATH</span></code>. Running the next cell will
check if a model trained in the <a class="reference external" href="pytorch-monai-training.ipynb">training
notebook</a> is saved in <code class="docutils literal notranslate"><span class="pre">MODEL_DIR</span></code> and
if so, use that. If there is no trained model, the pre-trained model
will be used. The optimized OpenVINO Intermediate Representation
(OpenVINO IR) model will be saved in the <code class="docutils literal notranslate"><span class="pre">MODEL_DIR</span></code> directory.</p>
<p>By default, this notebook will download one CT scan from KiTS19 dataset,
and use that for quantization. To use the full dataset, set <code class="docutils literal notranslate"><span class="pre">BASEDIR</span></code>
to the path of the dataset, as prepared according to the <a class="reference external" href="data-preparation-ct-scan.ipynb">Data
Preparation</a> notebook.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>BASEDIR = Path(&quot;kits19_frames_1&quot;)
# Uncomment the line below to use the full dataset, as prepared in the data preparation notebook.
# BASEDIR = Path(&quot;~/kits19/kits19_frames&quot;).expanduser()
MODEL_DIR = Path(&quot;model&quot;)
ONNX_PATH = MODEL_DIR / &quot;unet_kits19.onnx&quot;
if not ONNX_PATH.exists():
    ONNX_PATH = Path(&quot;pretrained_model/pretrained_unet_kits19.onnx&quot;)
assert ONNX_PATH.exists(), f&quot;ONNX_PATH: {ONNX_PATH} does not exist&quot;

ir_path = (MODEL_DIR / ONNX_PATH.stem).with_suffix(&quot;.xml&quot;)

print(f&quot;ONNX model: {ONNX_PATH}&quot;)
print(f&quot;Optimized model will be saved to: {ir_path}&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ONNX</span> <span class="n">model</span><span class="p">:</span> <span class="n">pretrained_model</span><span class="o">/</span><span class="n">pretrained_unet_kits19</span><span class="o">.</span><span class="n">onnx</span>
<span class="n">Optimized</span> <span class="n">model</span> <span class="n">will</span> <span class="n">be</span> <span class="n">saved</span> <span class="n">to</span><span class="p">:</span> <span class="n">model</span><span class="o">/</span><span class="n">pretrained_unet_kits19</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
</section>
<section id="download-ct-scan-data">
<h2>Download CT-scan Data<a class="headerlink" href="#download-ct-scan-data" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># The CT scan case number. For example: 2 for data from the case_00002 directory.
# Currently, only 117 is supported.
CASE = 117
if not (BASEDIR / f&quot;case_{CASE:05d}&quot;).exists():
    BASEDIR.mkdir(exist_ok=True)
    filename = download_file(
        f&quot;https://storage.openvinotoolkit.org/data/test_data/openvino_notebooks/kits19/case_{CASE:05d}.zip&quot;
    )
    with zipfile.ZipFile(filename, &quot;r&quot;) as zip_ref:
        zip_ref.extractall(path=BASEDIR)
    os.remove(filename)  # remove zipfile
    print(f&quot;Downloaded and extracted data for case_{CASE:05d}&quot;)
else:
    print(f&quot;Data for case_{CASE:05d} exists&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Data</span> <span class="k">for</span> <span class="n">case_00117</span> <span class="n">exists</span>
</pre></div>
</div>
</section>
<section id="convert-model-to-openvino-ir">
<h2>Convert Model to OpenVINO IR<a class="headerlink" href="#convert-model-to-openvino-ir" title="Permalink to this headline">Â¶</a></h2>
<p>Use Model Optimizer to convert the ONNX model to OpenVINO IR, with
<code class="docutils literal notranslate"><span class="pre">FP16</span></code> precision. The model files are saved to the <code class="docutils literal notranslate"><span class="pre">MODEL_DIR</span></code>
directory. For more information, see the <a class="reference external" href="https://docs.openvino.ai/latest/openvino_docs_MO_DG_Deep_Learning_Model_Optimizer_DevGuide.html">Model Optimizer Developer
Guide</a>.</p>
<p>When model optimization is successful, the last lines of the output will
include <code class="docutils literal notranslate"><span class="pre">[</span> <span class="pre">SUCCESS</span> <span class="pre">]</span> <span class="pre">Generated</span> <span class="pre">IR</span> <span class="pre">version</span> <span class="pre">10</span> <span class="pre">model</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>MODEL_DIR.mkdir(exist_ok=True)
!mo --input_model $ONNX_PATH --output_dir $MODEL_DIR --data_type FP16
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span> <span class="n">Optimizer</span> <span class="n">arguments</span><span class="p">:</span>
<span class="n">Common</span> <span class="n">parameters</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Input</span> <span class="n">Model</span><span class="p">:</span>  <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">k8sworker</span><span class="o">/</span><span class="n">cibuilds</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">OVNotebookOps</span><span class="o">-</span><span class="mi">231</span><span class="o">/.</span><span class="n">workspace</span><span class="o">/</span><span class="n">scm</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">110</span><span class="o">-</span><span class="n">ct</span><span class="o">-</span><span class="n">segmentation</span><span class="o">-</span><span class="n">quantize</span><span class="o">/</span><span class="n">pretrained_model</span><span class="o">/</span><span class="n">pretrained_unet_kits19</span><span class="o">.</span><span class="n">onnx</span>
    <span class="o">-</span> <span class="n">Path</span> <span class="k">for</span> <span class="n">generated</span> <span class="n">IR</span><span class="p">:</span>    <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">k8sworker</span><span class="o">/</span><span class="n">cibuilds</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">OVNotebookOps</span><span class="o">-</span><span class="mi">231</span><span class="o">/.</span><span class="n">workspace</span><span class="o">/</span><span class="n">scm</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">110</span><span class="o">-</span><span class="n">ct</span><span class="o">-</span><span class="n">segmentation</span><span class="o">-</span><span class="n">quantize</span><span class="o">/</span><span class="n">model</span>
    <span class="o">-</span> <span class="n">IR</span> <span class="n">output</span> <span class="n">name</span><span class="p">:</span>   <span class="n">pretrained_unet_kits19</span>
    <span class="o">-</span> <span class="n">Log</span> <span class="n">level</span><span class="p">:</span>    <span class="n">ERROR</span>
    <span class="o">-</span> <span class="n">Batch</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Input</span> <span class="n">layers</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Output</span> <span class="n">layers</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Input</span> <span class="n">shapes</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">model</span>
    <span class="o">-</span> <span class="n">Source</span> <span class="n">layout</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Target</span> <span class="n">layout</span><span class="p">:</span>    <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Layout</span><span class="p">:</span>   <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Mean</span> <span class="n">values</span><span class="p">:</span>  <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Scale</span> <span class="n">values</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Scale</span> <span class="n">factor</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Precision</span> <span class="n">of</span> <span class="n">IR</span><span class="p">:</span>  <span class="n">FP16</span>
    <span class="o">-</span> <span class="n">Enable</span> <span class="n">fusing</span><span class="p">:</span>    <span class="kc">True</span>
    <span class="o">-</span> <span class="n">User</span> <span class="n">transformations</span><span class="p">:</span>     <span class="n">Not</span> <span class="n">specified</span>
    <span class="o">-</span> <span class="n">Reverse</span> <span class="nb">input</span> <span class="n">channels</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Enable</span> <span class="n">IR</span> <span class="n">generation</span> <span class="k">for</span> <span class="n">fixed</span> <span class="nb">input</span> <span class="n">shape</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">transformations</span> <span class="n">config</span> <span class="n">file</span><span class="p">:</span>  <span class="kc">None</span>
<span class="n">Advanced</span> <span class="n">parameters</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Force</span> <span class="n">the</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">legacy</span> <span class="n">Frontend</span> <span class="n">of</span> <span class="n">Model</span> <span class="n">Optimizer</span> <span class="k">for</span> <span class="n">model</span> <span class="n">conversion</span> <span class="n">into</span> <span class="n">IR</span><span class="p">:</span>   <span class="kc">False</span>
    <span class="o">-</span> <span class="n">Force</span> <span class="n">the</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">new</span> <span class="n">Frontend</span> <span class="n">of</span> <span class="n">Model</span> <span class="n">Optimizer</span> <span class="k">for</span> <span class="n">model</span> <span class="n">conversion</span> <span class="n">into</span> <span class="n">IR</span><span class="p">:</span>  <span class="kc">False</span>
<span class="n">OpenVINO</span> <span class="n">runtime</span> <span class="n">found</span> <span class="ow">in</span><span class="p">:</span>  <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">k8sworker</span><span class="o">/</span><span class="n">cibuilds</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">OVNotebookOps</span><span class="o">-</span><span class="mi">231</span><span class="o">/.</span><span class="n">workspace</span><span class="o">/</span><span class="n">scm</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">openvino</span>
<span class="n">OpenVINO</span> <span class="n">runtime</span> <span class="n">version</span><span class="p">:</span>   <span class="mf">2022.1.0</span><span class="o">-</span><span class="mi">7019</span><span class="o">-</span><span class="n">cdb9bec7210</span><span class="o">-</span><span class="n">releases</span><span class="o">/</span><span class="mi">2022</span><span class="o">/</span><span class="mi">1</span>
<span class="n">Model</span> <span class="n">Optimizer</span> <span class="n">version</span><span class="p">:</span>    <span class="mf">2022.1.0</span><span class="o">-</span><span class="mi">7019</span><span class="o">-</span><span class="n">cdb9bec7210</span><span class="o">-</span><span class="n">releases</span><span class="o">/</span><span class="mi">2022</span><span class="o">/</span><span class="mi">1</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Generated</span> <span class="n">IR</span> <span class="n">version</span> <span class="mi">11</span> <span class="n">model</span><span class="o">.</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">XML</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">k8sworker</span><span class="o">/</span><span class="n">cibuilds</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">OVNotebookOps</span><span class="o">-</span><span class="mi">231</span><span class="o">/.</span><span class="n">workspace</span><span class="o">/</span><span class="n">scm</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">110</span><span class="o">-</span><span class="n">ct</span><span class="o">-</span><span class="n">segmentation</span><span class="o">-</span><span class="n">quantize</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">pretrained_unet_kits19</span><span class="o">.</span><span class="n">xml</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">BIN</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">k8sworker</span><span class="o">/</span><span class="n">cibuilds</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">OVNotebookOps</span><span class="o">-</span><span class="mi">231</span><span class="o">/.</span><span class="n">workspace</span><span class="o">/</span><span class="n">scm</span><span class="o">/</span><span class="n">ov</span><span class="o">-</span><span class="n">notebook</span><span class="o">/</span><span class="n">notebooks</span><span class="o">/</span><span class="mi">110</span><span class="o">-</span><span class="n">ct</span><span class="o">-</span><span class="n">segmentation</span><span class="o">-</span><span class="n">quantize</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">pretrained_unet_kits19</span><span class="o">.</span><span class="n">bin</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Total</span> <span class="n">execution</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.42</span> <span class="n">seconds</span><span class="o">.</span>
<span class="p">[</span> <span class="n">SUCCESS</span> <span class="p">]</span> <span class="n">Memory</span> <span class="n">consumed</span><span class="p">:</span> <span class="mi">84</span> <span class="n">MB</span><span class="o">.</span>
<span class="n">It</span><span class="s1">&#39;s been a while, check for a new version of Intel(R) Distribution of OpenVINO(TM) toolkit here https://software.intel.com/content/www/us/en/develop/tools/openvino-toolkit/download.html?cid=other&amp;source=prod&amp;campid=ww_2022_bu_IOTG_OpenVINO-2022-1&amp;content=upg_all&amp;medium=organic or on the GitHub*</span>
<span class="p">[</span> <span class="n">INFO</span> <span class="p">]</span> <span class="n">The</span> <span class="n">model</span> <span class="n">was</span> <span class="n">converted</span> <span class="n">to</span> <span class="n">IR</span> <span class="n">v11</span><span class="p">,</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">model</span> <span class="nb">format</span> <span class="n">that</span> <span class="n">corresponds</span> <span class="n">to</span> <span class="n">the</span> <span class="n">source</span> <span class="n">DL</span> <span class="n">framework</span> <span class="nb">input</span><span class="o">/</span><span class="n">output</span> <span class="nb">format</span><span class="o">.</span> <span class="n">While</span> <span class="n">IR</span> <span class="n">v11</span> <span class="ow">is</span> <span class="n">backwards</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">OpenVINO</span> <span class="n">Inference</span> <span class="n">Engine</span> <span class="n">API</span> <span class="n">v1</span><span class="mf">.0</span><span class="p">,</span> <span class="n">please</span> <span class="n">use</span> <span class="n">API</span> <span class="n">v2</span><span class="mf">.0</span> <span class="p">(</span><span class="k">as</span> <span class="n">of</span> <span class="mf">2022.1</span><span class="p">)</span> <span class="n">to</span> <span class="n">take</span> <span class="n">advantage</span> <span class="n">of</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">improvements</span> <span class="ow">in</span> <span class="n">IR</span> <span class="n">v11</span><span class="o">.</span>
<span class="n">Find</span> <span class="n">more</span> <span class="n">information</span> <span class="n">about</span> <span class="n">API</span> <span class="n">v2</span><span class="mf">.0</span> <span class="ow">and</span> <span class="n">IR</span> <span class="n">v11</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">openvino</span><span class="o">.</span><span class="n">ai</span>
</pre></div>
</div>
</section>
<section id="post-training-optimization-tool-pot-quantization">
<h2>Post-Training Optimization Tool (POT) Quantization<a class="headerlink" href="#post-training-optimization-tool-pot-quantization" title="Permalink to this headline">Â¶</a></h2>
<p>The Post-Training Optimization Tool (POT) <code class="docutils literal notranslate"><span class="pre">compression</span></code> API defines
base classes for <code class="docutils literal notranslate"><span class="pre">Metric</span></code> and <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>. This notebook uses a
custom Metric and DataLoader that show all the required methods.</p>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">Â¶</a></h3>
<section id="metric">
<h4>Metric<a class="headerlink" href="#metric" title="Permalink to this headline">Â¶</a></h4>
<p>Define a metric to determine the performance of the model. For the
Default Quantization algorithm that is used in this tutorial, defining a
metric is optional. The metric is used to compare the quantized <code class="docutils literal notranslate"><span class="pre">INT8</span></code>
model with the original <code class="docutils literal notranslate"><span class="pre">FP16</span></code> OpenVINO IR model.</p>
<p>A metric for POT inherits from <code class="docutils literal notranslate"><span class="pre">compression.api.Metric</span></code> and should
implement all the methods in this example.</p>
<p>For this demo, the <a class="reference external" href="https://en.wikipedia.org/wiki/F-score">F1 score</a>
or Dice coefficient is used. The same metric implementation is used in
the <a class="reference external" href="pytorch-monai-training.ipynb">training notebook</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># The sigmoid function is used to transform the result of the network
# to binary segmentation masks
def sigmoid(x):
    return np.exp(-np.logaddexp(0, -x))


class BinaryF1(Metric):
    &quot;&quot;&quot;
    Metric to compute F1/Dice score for binary segmentation. F1 is computed as
    (2 * precision * recall) / (precision + recall) where precision is computed as
    the ratio of pixels that were correctly predicted as true and all actual true pixels,
    and recall as the ratio of pixels that were correctly predicted as true and all
    predicted true pixels.

    See https://en.wikipedia.org/wiki/F-score
    &quot;&quot;&quot;

    # Required methods
    def __init__(self):
        super().__init__()
        self._name = &quot;F1&quot;
        self.y_true = 0
        self.y_pred = 0
        self.correct_true = 0

    @property
    def value(self):
        &quot;&quot;&quot;
        Returns metric value for the last model output.
        Possible format: {metric_name: [metric_values_per_image]}
        &quot;&quot;&quot;
        return {self._name: [0, 0]}

    @property
    def avg_value(self):
        &quot;&quot;&quot;
        Returns average metric value for all model outputs as {metric_name: metric_value}
        &quot;&quot;&quot;
        recall = self.correct_true / self.y_pred
        precision = self.correct_true / self.y_true

        f1 = (2 * precision * recall) / (precision + recall)
        return {self._name: f1}

    def update(self, output, target):
        &quot;&quot;&quot;
        Update the statistics for metric computation

        :param output: model output
        :param target: annotations for model output
        &quot;&quot;&quot;
        label = target[0].astype(np.byte)
        prediction = sigmoid(output[0]).round().astype(np.byte)

        self.y_true += np.sum(label)
        self.y_pred += np.sum(prediction)

        correct_true = np.sum(
            (label == prediction).astype(np.byte) * (label == 1).astype(np.byte)
        ).astype(np.float32)

        self.correct_true += correct_true

    def reset(self):
        &quot;&quot;&quot;
        Resets metric to initial values
        &quot;&quot;&quot;
        self.y_true = 0
        self.y_pred = 0
        self.correct_true = 0

    def get_attributes(self):
        &quot;&quot;&quot;
        Returns a dictionary of metric attributes {metric_name: {attribute_name: value}}.
        Required attributes: &#39;direction&#39;: &#39;higher-better&#39; or &#39;higher-worse&#39;
                             &#39;type&#39;: metric type
        &quot;&quot;&quot;
        return {self._name: {&quot;direction&quot;: &quot;higher-better&quot;, &quot;type&quot;: &quot;F1&quot;}}
</pre></div>
</div>
</section>
<section id="dataset">
<h4>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline">Â¶</a></h4>
<p>The KitsDataLoader in the next cell expects images and masks in the
<em>basedir</em> directory, in a folder per patient. For more information about
the data in the dataset, see the <a class="reference external" href="data-preparation-cit-scan.ipynb">data preparation
notebook</a>. This dataset follows
POTâ€™s <code class="docutils literal notranslate"><span class="pre">compression.api.DataLoader</span></code> interface, which should implement
<code class="docutils literal notranslate"><span class="pre">__init__</span></code>, <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and <code class="docutils literal notranslate"><span class="pre">__len__</span></code>, where
<code class="docutils literal notranslate"><span class="pre">__getitem__(index)</span></code> returns <code class="docutils literal notranslate"><span class="pre">(annotion,</span> <span class="pre">image)</span></code> or
<code class="docutils literal notranslate"><span class="pre">(annotation,</span> <span class="pre">image,</span> <span class="pre">metadata)</span></code> and <code class="docutils literal notranslate"><span class="pre">annotation</span></code> consists of
<code class="docutils literal notranslate"><span class="pre">(index,</span> <span class="pre">label)</span></code>.</p>
<p>Images are loaded with MONAIâ€™s
<code class="docutils literal notranslate"><span class="pre">`LoadImage</span></code> &lt;<a class="reference external" href="https://docs.monai.io/en/stable/transforms.html#loadimage">https://docs.monai.io/en/stable/transforms.html#loadimage</a>&gt;`__,
to align with the image loading method in the <a class="reference external" href="pytorch-monai-training.ipynb">training
notebook</a>. This method rotates and
flips the images. We define a <code class="docutils literal notranslate"><span class="pre">rotate_and_flip</span></code> method to display the
images in the expected orientation.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def rotate_and_flip(image):
    &quot;&quot;&quot;Rotate `image` by 90 degrees and flip horizontally&quot;&quot;&quot;
    return cv2.flip(cv2.rotate(image, rotateCode=cv2.ROTATE_90_CLOCKWISE), flipCode=1)


class KitsDataLoader(DataLoader):
    def __init__(self, basedir: str):
        &quot;&quot;&quot;
        DataLoader class for prepared KiTS19 data, for binary segmentation (background/kidney)
        Source data should exist in basedir, in subdirectories case_00000 until case_00210,
        with each subdirectory containing directories imaging_frames, with jpg images, and
        segmentation_frames with segmentation masks as png files.
        See https://github.com/openvinotoolkit/openvino_notebooks/blob/main/notebooks/110-ct-segmentation-quantize/data-preparation-ct-scan.ipynb

        For demonstration purposes, in this implementation we use images from the validation subset.

        :param basedir: Directory that contains the prepared CT scans
        &quot;&quot;&quot;
        allmasks = sorted(BASEDIR.glob(&quot;case_*/segmentation_frames/*png&quot;))

        if len(allmasks) == 0:
            raise ValueError(f&quot;basedir: &#39;{basedir}&#39; does not contain data&quot;)
        val_indices = [7, 10, 14, 15, 30, 60, 71, 74, 75, 81, 92, 93,
                       106, 115, 117, 119, 134, 161, 192, 196, 203]  # fmt: skip
        val_cases = [f&quot;case_{i:05d}&quot; for i in val_indices]
        masks = [mask for mask in allmasks if mask.parents[1].name in val_cases]

        self.basedir = basedir
        self.dataset = masks
        print(
            f&quot;Created dataset with {len(self.dataset)} items. &quot;
            f&quot;Base directory for data: {basedir}&quot;
        )

    def __getitem__(self, index):
        &quot;&quot;&quot;
        Get an item from the dataset at the specified index.

        :return: (annotation, input_image, metadata) where annotation is (index, segmentation_mask)
                 and metadata a dictionary with case and slice number
        &quot;&quot;&quot;
        mask_path = self.dataset[index]
        image_path = str(mask_path.with_suffix(&quot;.jpg&quot;)).replace(
            &quot;segmentation_frames&quot;, &quot;imaging_frames&quot;
        )

        # Load images with MONAI&#39;s LoadImage to match data loading in training notebook
        mask = LoadImage(image_only=True, dtype=np.uint8)(str(mask_path)).numpy()
        img = LoadImage(image_only=True, dtype=np.float32)(str(image_path)).numpy()

        if img.shape[:2] != (512, 512):
            img = cv2.resize(img.astype(np.uint8), (512, 512)).astype(np.float32)
            mask = cv2.resize(mask, (512, 512))

        annotation = (index, mask)
        input_image = np.expand_dims(img, axis=0)
        return (
            annotation,
            input_image,
            {&quot;case&quot;: Path(mask_path).parents[1].name, &quot;slice&quot;: Path(mask_path).stem},
        )

    def __len__(self):
        return len(self.dataset)
</pre></div>
</div>
<p>To test that the data loader returns the expected output, we create a
DataLoader instance and show an image and a mask. The image and mask are
shown as returned by the dataloader, after resizing and preprocessing.
Since this dataset contains a lot of slices without kidneys, we select a
slice that contains at least 5000 kidney pixels to verify that the
annotations look correct.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data_loader = KitsDataLoader(BASEDIR)

# Find a slice that contains kidney annotations
# item[0] is the annotation: (id, annotation_data)
annotation, image_data, _ = next(
    item for item in data_loader if np.count_nonzero(item[0][1]) &gt; 5000
)
# Remove extra image dimension and rotate and flip the image for visualization
image = rotate_and_flip(image_data.squeeze())

# The data loader returns annotations as (index, mask) and mask in shape (H,W)
mask = rotate_and_flip(annotation[1])

fig, ax = plt.subplots(1, 2, figsize=(12, 6))
ax[0].imshow(image, cmap=&quot;gray&quot;)
ax[1].imshow(mask, cmap=&quot;gray&quot;);
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">dataset</span> <span class="k">with</span> <span class="mi">69</span> <span class="n">items</span><span class="o">.</span> <span class="n">Base</span> <span class="n">directory</span> <span class="k">for</span> <span class="n">data</span><span class="p">:</span> <span class="n">kits19_frames_1</span>
</pre></div>
</div>
<img alt="../_images/110-ct-segmentation-quantize-with-output_15_1.png" src="../_images/110-ct-segmentation-quantize-with-output_15_1.png" />
</section>
<section id="quantization-config">
<h4>Quantization Config<a class="headerlink" href="#quantization-config" title="Permalink to this headline">Â¶</a></h4>
<p>POT methods expect configuration dictionaries as arguments, which are
defined in the cell below. The variable <code class="docutils literal notranslate"><span class="pre">ir_path</span></code> is defined in the
<a class="reference external" href="#Settings">Settings</a> cell at the top of the notebook. The other
variables are defined in the cell above.</p>
<p>See <a class="reference external" href="https://docs.openvino.ai/2021.4/pot_docs_BestPractices.html">Post-Training Optimization Best
Practices</a>
for more information on the settings.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Model config specifies the model name and paths to model .xml and .bin file
model_config = Dict(
    {
        &quot;model_name&quot;: f&quot;quantized_{ir_path.stem}&quot;,
        &quot;model&quot;: ir_path,
        &quot;weights&quot;: ir_path.with_suffix(&quot;.bin&quot;),
    }
)

# Engine config
engine_config = Dict({&quot;device&quot;: &quot;CPU&quot;})

algorithms = [
    {
        &quot;name&quot;: &quot;DefaultQuantization&quot;,
        &quot;stat_subset_size&quot;: 1000,
        &quot;params&quot;: {
            &quot;target_device&quot;: &quot;ANY&quot;,
            &quot;preset&quot;: &quot;performance&quot;,  # choose between &quot;mixed&quot; and &quot;performance&quot;
        },
    }
]

print(f&quot;model_config: {model_config}&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model_config</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;quantized_pretrained_unet_kits19&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;model/pretrained_unet_kits19.xml&#39;</span><span class="p">),</span> <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;model/pretrained_unet_kits19.bin&#39;</span><span class="p">)}</span>
</pre></div>
</div>
</section>
</section>
<section id="run-quantization-pipeline">
<h3>Run Quantization Pipeline<a class="headerlink" href="#run-quantization-pipeline" title="Permalink to this headline">Â¶</a></h3>
<p>The POT pipeline needs a loaded model, an <code class="docutils literal notranslate"><span class="pre">IEEngine</span></code> instance, a POT
implementation of OpenVINO Runtime, and finally a POT <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>
instance. The POT classes and functions expect a config argument. These
configs are created in the Config section in the cell above. The F1
metric and <code class="docutils literal notranslate"><span class="pre">SegmentationDataLoader</span></code> are defined earlier in this
notebook.</p>
<p>Running the POT quantization pipeline takes just two lines of code.
Create the pipeline with the <code class="docutils literal notranslate"><span class="pre">create_pipeline</span></code> function, and then run
that pipeline with the <code class="docutils literal notranslate"><span class="pre">pipeline.run()</span></code> method. To reuse the quantized
model later, compress the model weights and save the compressed model to
a disk.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Step 1: Create the data loader.
data_loader = KitsDataLoader(BASEDIR)

# Step 2: Load the model.
ir_model = load_model(model_config=model_config)

# Step 3: Initialize the metric.
metric = BinaryF1()

# Step 4: Initialize the engine for metric calculation and statistics collection.
engine = IEEngine(config=engine_config, data_loader=data_loader, metric=metric)

# Step 5: Create a pipeline of compression algorithms.
# The `quantization_algorithm` parameter is defined in the Settings.
pipeline = create_pipeline(algorithms, engine)

# Step 6: Execute the pipeline to quantize the model.
algorithm_name = pipeline.algo_seq[0].name
preset = pipeline._algo_seq[0].config[&quot;preset&quot;]
with yaspin(
    text=f&quot;Executing POT pipeline on {model_config[&#39;model&#39;]} with {algorithm_name}, {preset} preset&quot;
) as sp:
    start_time = time.perf_counter()
    compressed_model = pipeline.run(ir_model)
    end_time = time.perf_counter()
    sp.text = f&quot;Quantization finished in {end_time - start_time:.2f} seconds&quot;
    sp.ok(&quot;âœ”&quot;)

# Step 7 (Optional): Compress model weights to quantized precision
#                    in order to reduce the size of the final .bin file.
compress_model_weights(compressed_model)

# Step 8: Save the compressed model to the desired path.
# Set `save_path` to the directory where the model should be saved.
compressed_model_paths = save_model(
    model=compressed_model,
    save_path=&quot;optimized_model&quot;,
    model_name=f&quot;{ir_model.name}_{preset}_{algorithm_name}&quot;,
)

compressed_model_path = compressed_model_paths[0][&quot;model&quot;]
print(&quot;The quantized model is stored at&quot;, compressed_model_path)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Created dataset with 69 items. Base directory for data: kits19_frames_1
âœ” Quantization finished in 35.69 seconds
The quantized model is stored at optimized_model/quantized_pretrained_unet_kits19_performance_DefaultQuantization.xml
</pre></div>
</div>
</section>
</section>
<section id="compare-metrics-of-fp16-and-int8-model">
<h2>Compare Metrics of FP16 and INT8 Model<a class="headerlink" href="#compare-metrics-of-fp16-and-int8-model" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Compute the F1 score on the original and quantized model.
ir_model = load_model(model_config=model_config)
evaluation_pipeline = create_pipeline(algo_config=algorithms, engine=engine)

with yaspin(text=&quot;Evaluating original IR model&quot;) as sp:
    original_metric = evaluation_pipeline.evaluate(ir_model)

with yaspin(text=&quot;Evaluating quantized IR model&quot;) as sp:
    quantized_metric = pipeline.evaluate(compressed_model)

if original_metric:
    for key, value in original_metric.items():
        print(f&quot;The {key} score of the original FP16 model is {value:.3f}&quot;)

if quantized_metric:
    for key, value in quantized_metric.items():
        print(f&quot;The {key} score of the quantized INT8 model is {value:.3f}&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">F1</span> <span class="n">score</span> <span class="n">of</span> <span class="n">the</span> <span class="n">original</span> <span class="n">FP16</span> <span class="n">model</span> <span class="ow">is</span> <span class="mf">0.977</span>
<span class="n">The</span> <span class="n">F1</span> <span class="n">score</span> <span class="n">of</span> <span class="n">the</span> <span class="n">quantized</span> <span class="n">INT8</span> <span class="n">model</span> <span class="ow">is</span> <span class="mf">0.976</span>
</pre></div>
</div>
</section>
<section id="compare-performance-of-the-original-and-quantized-models">
<h2>Compare Performance of the Original and Quantized Models<a class="headerlink" href="#compare-performance-of-the-original-and-quantized-models" title="Permalink to this headline">Â¶</a></h2>
<p>To measure the inference performance of the <code class="docutils literal notranslate"><span class="pre">FP16</span></code> and <code class="docutils literal notranslate"><span class="pre">INT8</span></code>
models, use <a class="reference external" href="https://docs.openvino.ai/latest/openvino_inference_engine_tools_benchmark_tool_README.html">Benchmark
Tool</a>
- inference performance measurement tool in OpenVINO. Benchmark tool is
a command-line application that can be run in the notebook with
<code class="docutils literal notranslate"><span class="pre">!</span> <span class="pre">benchmark_app</span></code> or <code class="docutils literal notranslate"><span class="pre">%sx</span> <span class="pre">benchmark_app</span></code> commands.</p>
<p>This tutorial uses a wrapper function from <a class="reference external" href="https://github.com/openvinotoolkit/openvino_notebooks/blob/main/notebooks/utils/notebook_utils.ipynb">Notebook
Utils</a>.
It prints the <code class="docutils literal notranslate"><span class="pre">benchmark_app</span></code> command with the chosen parameters.</p>
<blockquote>
<div><p><strong>Note</strong>: For the most accurate performance estimation, it is
recommended to run <code class="docutils literal notranslate"><span class="pre">benchmark_app</span></code> in a terminal/command prompt
after closing other applications. Run <code class="docutils literal notranslate"><span class="pre">benchmark_app</span> <span class="pre">--help</span></code> to see
all command-line options.</p>
</div></blockquote>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Show the parameters and docstring for `benchmark_model`.
benchmark_model?
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># By default, benchmark on MULTI:CPU,GPU if a GPU is available, otherwise on CPU.
ie = IECore()
device = &quot;MULTI:CPU,GPU&quot; if &quot;GPU&quot; in ie.available_devices else &quot;CPU&quot;
# Uncomment one of the options below to benchmark on other devices
# device = &quot;GPU&quot;
# device = &quot;CPU&quot;
# device = &quot;AUTO&quot;
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Benchmark FP16 model
benchmark_model(model_path=ir_path, device=device, seconds=15)
</pre></div>
</div>
<p><strong>Benchmark pretrained_unet_kits19.xml with CPU for 15 seconds with
async inference</strong></p>
<p>Benchmark command:
<code class="docutils literal notranslate"><span class="pre">benchmark_app</span> <span class="pre">-m</span> <span class="pre">model/pretrained_unet_kits19.xml</span> <span class="pre">-d</span> <span class="pre">CPU</span> <span class="pre">-t</span> <span class="pre">15</span> <span class="pre">-api</span> <span class="pre">async</span> <span class="pre">-b</span> <span class="pre">1</span> <span class="pre">-cdir</span> <span class="pre">model_cache</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Count</span><span class="p">:</span>          <span class="mi">408</span> <span class="n">iterations</span>
<span class="n">Duration</span><span class="p">:</span>       <span class="mf">15350.12</span> <span class="n">ms</span>
<span class="n">Latency</span><span class="p">:</span>
    <span class="n">Median</span><span class="p">:</span>     <span class="mf">224.90</span> <span class="n">ms</span>
    <span class="n">AVG</span><span class="p">:</span>        <span class="mf">224.75</span> <span class="n">ms</span>
    <span class="n">MIN</span><span class="p">:</span>        <span class="mf">180.09</span> <span class="n">ms</span>
    <span class="n">MAX</span><span class="p">:</span>        <span class="mf">259.13</span> <span class="n">ms</span>
<span class="n">Throughput</span><span class="p">:</span> <span class="mf">26.58</span> <span class="n">FPS</span>

<span class="n">Device</span><span class="p">:</span> <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Core</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="n">i9</span><span class="o">-</span><span class="mi">10920</span><span class="n">X</span> <span class="n">CPU</span> <span class="o">@</span> <span class="mf">3.50</span><span class="n">GHz</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Benchmark INT8 model
benchmark_model(model_path=compressed_model_path, device=device, seconds=15)
</pre></div>
</div>
<p><strong>Benchmark
quantized_pretrained_unet_kits19_performance_DefaultQuantization.xml
with CPU for 15 seconds with async inference</strong></p>
<p>Benchmark command:
<code class="docutils literal notranslate"><span class="pre">benchmark_app</span> <span class="pre">-m</span> <span class="pre">optimized_model/quantized_pretrained_unet_kits19_performance_DefaultQuantization.xml</span> <span class="pre">-d</span> <span class="pre">CPU</span> <span class="pre">-t</span> <span class="pre">15</span> <span class="pre">-api</span> <span class="pre">async</span> <span class="pre">-b</span> <span class="pre">1</span> <span class="pre">-cdir</span> <span class="pre">model_cache</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Count</span><span class="p">:</span>          <span class="mi">1548</span> <span class="n">iterations</span>
<span class="n">Duration</span><span class="p">:</span>       <span class="mf">15108.09</span> <span class="n">ms</span>
<span class="n">Latency</span><span class="p">:</span>
    <span class="n">Median</span><span class="p">:</span>     <span class="mf">58.27</span> <span class="n">ms</span>
    <span class="n">AVG</span><span class="p">:</span>        <span class="mf">58.44</span> <span class="n">ms</span>
    <span class="n">MIN</span><span class="p">:</span>        <span class="mf">51.08</span> <span class="n">ms</span>
    <span class="n">MAX</span><span class="p">:</span>        <span class="mf">78.69</span> <span class="n">ms</span>
<span class="n">Throughput</span><span class="p">:</span> <span class="mf">102.46</span> <span class="n">FPS</span>

<span class="n">Device</span><span class="p">:</span> <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Core</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="n">i9</span><span class="o">-</span><span class="mi">10920</span><span class="n">X</span> <span class="n">CPU</span> <span class="o">@</span> <span class="mf">3.50</span><span class="n">GHz</span>
</pre></div>
</div>
</section>
<section id="visually-compare-inference-results">
<h2>Visually Compare Inference Results<a class="headerlink" href="#visually-compare-inference-results" title="Permalink to this headline">Â¶</a></h2>
<p>Visualize the results of the model on four slices of the validation set.
Compare the results of the FP16 IR model with the results of the
quantized INT8 model and the reference segmentation annotation.</p>
<p>Medical imaging datasets tend to be very imbalanced: most of the slices
in a CT scan do not contain kidney data. The segmentation model should
be good at finding kidneys where they exist (in medical terms: have good
sensitivity) but also not find spurious kidneys that do not exist (have
good specificity). In the next cell, we show four slices: two slices
that have no kidney data, and two slices that contain kidney data. For
this example, a slice has kidney data if at least 50 pixels in the
slices are annotated as kidney.</p>
<p>Run this cell again to show results on a different subset. The random
seed is displayed to allow reproducing specific runs of this cell.</p>
<blockquote>
<div><p><strong>Note</strong>: the images are shown after optional augmenting and
resizing. In the KiTS19 dataset all but one of the cases has input
shape <code class="docutils literal notranslate"><span class="pre">(512,</span> <span class="pre">512)</span></code>.</p>
</div></blockquote>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>num_images = 4
colormap = &quot;gray&quot;

ie = IECore()
net_ir = ie.read_network(ir_path)
net_pot = ie.read_network(compressed_model_path)

exec_net_ir = ie.load_network(network=net_ir, device_name=&quot;CPU&quot;)
exec_net_pot = ie.load_network(network=net_pot, device_name=&quot;CPU&quot;)
input_layer = next(iter(net_ir.input_info))
output_layer_ir = next(iter(net_ir.outputs))
output_layer_pot = next(iter(net_pot.outputs))
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Create a dataset and make a subset of the dataset for visualization.
# The dataset items are (annotation, image) where annotation is (index, mask).
background_slices = (item for item in data_loader if np.count_nonzero(item[0][1]) == 0)
kidney_slices = (item for item in data_loader if np.count_nonzero(item[0][1]) &gt; 50)
# Set `seed` to current time. To reproduce specific results, copy the printed seed
# and manually set `seed` to that value.
seed = int(time.time())
random.seed(seed)
print(f&quot;Visualizing results with seed {seed}&quot;)
data_subset = random.sample(list(background_slices), 2) + random.sample(list(kidney_slices), 2)

fig, ax = plt.subplots(nrows=num_images, ncols=4, figsize=(24, num_images * 4))
for i, (annotation, image, meta) in enumerate(data_subset):
    display_image = rotate_and_flip(image.squeeze())
    mask = rotate_and_flip(annotation[1])
    res_ir = exec_net_ir.infer(inputs={input_layer: image})
    res_pot = exec_net_pot.infer(inputs={input_layer: image})
    target_mask = mask.astype(np.uint8)

    result_mask_ir = sigmoid(res_ir[output_layer_ir]).round().astype(np.uint8)[0, 0, ::]
    result_mask_pot = sigmoid(res_pot[output_layer_pot]).round().astype(np.uint8)[0, 0, ::]
    result_mask_ir = rotate_and_flip(result_mask_ir)
    result_mask_pot = rotate_and_flip(result_mask_pot)

    ax[i, 0].imshow(display_image, cmap=colormap)
    ax[i, 1].imshow(target_mask, cmap=colormap)
    ax[i, 2].imshow(result_mask_ir, cmap=colormap)
    ax[i, 3].imshow(result_mask_pot, cmap=colormap)
    ax[i, 0].set_title(f&quot;{meta[&#39;slice&#39;]}&quot;)
    ax[i, 1].set_title(&quot;Annotation&quot;)
    ax[i, 2].set_title(&quot;Prediction on FP16 model&quot;)
    ax[i, 3].set_title(&quot;Prediction on INT8 model&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Visualizing</span> <span class="n">results</span> <span class="k">with</span> <span class="n">seed</span> <span class="mi">1663101200</span>
</pre></div>
</div>
<img alt="../_images/110-ct-segmentation-quantize-with-output_29_1.png" src="../_images/110-ct-segmentation-quantize-with-output_29_1.png" />
</section>
<section id="show-live-inference">
<h2>Show Live Inference<a class="headerlink" href="#show-live-inference" title="Permalink to this headline">Â¶</a></h2>
<p>To show live inference on the model in the notebook, use the
asynchronous processing feature of OpenVINO Runtime.</p>
<p>If you use a GPU device, with <code class="docutils literal notranslate"><span class="pre">device=&quot;GPU&quot;</span></code> or
<code class="docutils literal notranslate"><span class="pre">device=&quot;MULTI:CPU,GPU&quot;</span></code> to do inference on an integrated graphics
card, model loading will be slow the first time you run this code. The
model will be cached, so model loading will be faster after the first
time. For more information on OpenVINO Runtime, including Model Caching,
see the <a class="reference external" href="002-openvino-api-with-output.html">OpenVINO Runtime API
tutorial</a>.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">show_live_inference</span></code> function from <a class="reference external" href="utils-with-output.html">Notebook
Utils</a> to show live inference. This
function uses AsyncPipeline and <a class="reference external" href="https://docs.openvino.ai/latest/omz_python_model_api.html">Model
API</a> from
<a class="reference external" href="https://github.com/openvinotoolkit/open_model_zoo/">Open Model Zoo</a>
to perform asynchronous inference. Once inference on the specified CT
scan has completed, the total time and throughput (fps), including
preprocessing and displaying, will be printed.</p>
<section id="load-model-and-list-of-image-files">
<h3>Load Model and List of Image Files<a class="headerlink" href="#load-model-and-list-of-image-files" title="Permalink to this headline">Â¶</a></h3>
<p>Load the segmentation model to OpenVINO Runtime with
<code class="docutils literal notranslate"><span class="pre">SegmentationModel</span></code>, based on the Model API from <a class="reference external" href="https://github.com/openvinotoolkit/open_model_zoo/">Open Model
Zoo</a>. This model
implementation includes pre and post processing for the model. For
<code class="docutils literal notranslate"><span class="pre">SegmentationModel</span></code>, this includes the code to create an overlay of
the segmentation mask on the original image/frame. Uncomment the next
cell to see the implementation.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># SegmentationModel??
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># CASE = 117

ie = IECore()
segmentation_model = SegmentationModel(
    ie=ie, model_path=Path(compressed_model_path), sigmoid=True, rotate_and_flip=True
)
case_path = BASEDIR / f&quot;case_{CASE:05d}&quot;
image_paths = sorted(case_path.glob(&quot;imaging_frames/*jpg&quot;))
print(f&quot;{case_path.name}, {len(image_paths)} images&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">case_00117</span><span class="p">,</span> <span class="mi">69</span> <span class="n">images</span>
</pre></div>
</div>
</section>
<section id="show-inference">
<h3>Show Inference<a class="headerlink" href="#show-inference" title="Permalink to this headline">Â¶</a></h3>
<p>In the next cell, run the <code class="docutils literal notranslate"><span class="pre">show_live_inference</span></code> function, which loads
the <code class="docutils literal notranslate"><span class="pre">segmentation_model</span></code> to the specified <code class="docutils literal notranslate"><span class="pre">device</span></code> (using caching
for faster model loading on GPU devices), loads the images, performs
inference, and displays the results on the frames loaded in the
<code class="docutils literal notranslate"><span class="pre">images</span></code> in real-time.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Possible options for a device include: &quot;CPU&quot;, &quot;GPU&quot;, &quot;AUTO&quot;, &quot;MULTI&quot;.
device = &quot;MULTI:CPU,GPU&quot; if &quot;GPU&quot; in ie.available_devices else &quot;CPU&quot;
reader = LoadImage(image_only=True, dtype=np.uint8)
show_live_inference(
    ie=ie, image_paths=image_paths, model=segmentation_model, device=device, reader=reader
)
</pre></div>
</div>
<img alt="../_images/110-ct-segmentation-quantize-with-output_35_0.jpg" src="../_images/110-ct-segmentation-quantize-with-output_35_0.jpg" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Loaded</span> <span class="n">model</span> <span class="n">to</span> <span class="n">CPU</span> <span class="ow">in</span> <span class="mf">0.16</span> <span class="n">seconds</span><span class="o">.</span>
<span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">68</span> <span class="n">frames</span><span class="p">:</span> <span class="mf">1.83</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">fps</span><span class="p">:</span><span class="mf">37.61</span>
</pre></div>
</div>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">Â¶</a></h2>
<p><strong>OpenVINO</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.openvino.ai/2021.4/pot_README.html">Post Training Optimization Tool
(POT)</a></p></li>
<li><p><a class="reference external" href="https://docs.openvino.ai/latest/openvino_docs_IE_DG_supported_plugins_MULTI.html">OpenVINO MULTI device
plugin</a></p></li>
<li><p><a class="reference external" href="002-openvino-api-with-output.html">OpenVINO API
Tutorial</a></p></li>
<li><p><a class="reference external" href="https://pypi.org/project/openvino-dev/">OpenVINO PyPI (pip install
openvino-dev)</a></p></li>
</ul>
<p><strong>Kits19 Data</strong> - <a class="reference external" href="https://kits19.grand-challenge.org/">KiTS19 Challenge
Homepage</a> - <a class="reference external" href="https://github.com/neheller/kits19">KiTS19 Github
Repository</a> - <a class="reference external" href="https://arxiv.org/abs/1904.00445">The KiTS19
Challenge Data: 300 Kidney Tumor Cases with Clinical Context, CT
Semantic Segmentations, and Surgical
Outcomes</a> - <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1361841520301857">The state of the art
in kidney and kidney tumor segmentation in contrast-enhanced CT imaging:
Results of the KiTS19
challenge</a></p>
</section>
</section>


                </div>
            
            
                <div class='prev-next-bottom'>
                  
    <a class='button bttn-sec button-size-l' id="prev-link" href="110-ct-segmentation-quantize-nncf-with-output.html" title="previous page">Prev</a>
    <a class='button bttn-sec button-size-l' id="next-link" href="111-detection-quantization-with-output.html" title="next page">Next</a>

                </div>
            
          </main>
          

      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, IntelÂ®.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>